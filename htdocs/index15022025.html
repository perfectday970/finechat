<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fine Chat</title>
  <style>
    /* Allgemeine Stile */
    body {
        font-family: system-ui, -apple-system, sans-serif;
        line-height: 1.6;
        margin: 20px;
        color: #333;
        background-color: #f9f9f9;
    }

    h1 {
        color: #2c3e50;
        font-size: 2rem;
        margin-bottom: 20px;
    }

    /* Layout für Chat, System-Prompt und Einstellungen */
    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .chat-area {
        flex: 1;
        min-width: 300px;
    }

    .settings-area {
        flex: 0 0 250px;
    }

    @media (max-width: 768px) {
        .settings-area {
            flex: 1 1 100%;
            order: 2; /* Einstellungen nach unten verschieben */
        }
    }

    /* System-Prompt */
    #systemPrompt {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        font-family: inherit;
        font-size: 1rem;
    }

    /* Sprachumschaltungs-Buttons */
    .language-buttons {
        margin-bottom: 20px;
    }

    .language-buttons button {
        padding: 5px 10px;
        margin-right: 10px;
        border: none;
        border-radius: 5px;
        background-color: #3498db;
        color: #fff;
        cursor: pointer;
    }

    .language-buttons button:hover {
        background-color: #2980b9;
    }

    /* Chatbox */
    .chatbox {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .chatbox p {
      white-space: pre-line; /* Zeilenumbrüche und Leerzeichen erhalten */
      margin: 5px 0;
    }

    /* Nachrichten-Stile */
    .user {
        color: #3498db; /* Blau für Benutzer */
        font-weight: bold;
    }

    .assistant {
        color: #27ae60; /* Grün für Assistant */
        font-weight: bold;
    }

    /* Think-Tag */
    think {
        display: inline-block;
        font-style: italic;
        color: #555;
        background-color: #f0f0f0;
        padding: 5px 10px;
        border-radius: 5px;
        border-left: 3px solid #888;
        margin: 5px 0;
    }

    thinking {
        display: inline-block;
        font-style: italic;
        color: #8a6d3b; /* Dunkles Gelb/Braun für den Text */
        background-color: #fcf8e3; /* Hellgelber Hintergrund */
        padding: 5px 10px;
        border-radius: 5px;
        border-left: 3px solid #faebcc; /* Gelblicher Rand */
        margin: 5px 0;
    }

    error {
        display: inline-block;
        font-style: italic;
        color: #721c24;
        background-color: #f8d7da;
        padding: 5px 10px;
        border-radius: 5px;
        border-left: 3px solid #dc3545;
        margin: 5px 0;
    }

    /* Eingabefeld und Buttons */
    input[type="text"] {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-right: 10px;
        font-size: 1rem;
    }

    button {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        background-color: #3498db;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #2980b9;
    }

    button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }

    /* Einstellungsbereich */
    #aiSettings {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        margin-bottom: 10px;
    }
    .waiting::after {
      content: " ";
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 6px;
      border-radius: 50%;
      background-color: gray;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }

  </style>
</head>
<body>
<h1>FineChat</h1>

<div class="container">
  <!-- Chat- und System-Prompt-Bereich -->
  <div class="chat-area">
    <!-- System-Prompt -->
    <textarea id="systemPrompt" placeholder="System-Prompt hier eingeben..."></textarea>
    <div class="language-buttons">
      <button onclick="setSystemPrompt('de')">DE</button>
      <button onclick="setSystemPrompt('en')">EN</button>
    </div>

    <!-- Chatbox -->
    <div id="chatbox" class="chatbox"></div>

    <!-- Eingabefeld + Buttons -->
    <input type="text" id="user_input" style="width:300px;" placeholder="Hier tippen ...">
    <button type="button" onclick="sendManual()">Senden</button>
    <button type="button" id="toggleBtn" onclick="toggleListening()">Spracheingabe starten</button>
    <button type="button" onclick="cancelTTS()">X</button>
  </div>

  <!-- Einstellungsbereich -->
  <div class="settings-area">
    <div id="aiSettings">
      <label for="ttsMode">TTS-Mode wählen:</label>
      <select id="ttsMode">
        <option value="coqui">Coqui TTS</option>
        <option value="browser">Browser TTS</option>
      </select>
      <label for="aiModel">KI-Modell wählen:</label>
      <select id="aiModel">
        <option value="deepseek">DeepSeek</option>
        <option value="ollama">Llama (Ollama)</option>
      </select>
      <label for="processingUnit">Verarbeitungseinheit wählen:</label>
      <select id="processingUnit">
        <option value="gpu">GPU</option>
        <option value="cpu">CPU</option>
      </select>
    </div>
  </div>
</div>

<script>
// ------------------ GLOBALE VARIABLEN ------------------
let recognition;              // Instanz der Web Speech API
let isListening = false;      // Merker für ein/aus
let finalTranscript = "";     // hier sammeln wir erkannte Endergebnisse
let lastSpeechTime = 0;       // Zeitstempel letztes onresult
let checkTimer;               // setInterval ID
let userInput = document.getElementById("user_input");
let isTTSRunning = false;
let firstRequest = true;
let chatArray = [];
let waiting = false;

// System-Prompts (vorbelegt)
const systemPrompts = {
  de: "Du bist ein hilfsbereiter Assistent. Antworte klar und präzise auf Deutsch. Wenn eine Frage einfach ist, antworten Sie direkt und schnell, auf natürliche Art und Weise, ohne nachzudenken.\n" +
          "Nur wenn eine Frage ein **tiefes Nachdenken** erfordert, erläutern Sie Ihre Gedanken im Detail, innerhalb des Denkbereichs, aber analysieren Sie nicht zu sehr.\n",
  en: "You are a helpful assistant. Respond clearly and concisely in English. If a question is simple, answer directly and quickly, in a natural way, without thinking.\n" +
          "Only if a question requires **deep thought**, explain your thoughts in detail, within the range of thought, but don't over analyze.\n"
};

// Setze den System-Prompt basierend auf der Sprache
function setSystemPrompt(lang) {
  document.getElementById("systemPrompt").value = systemPrompts[lang];
}


// ------------------ SESSION / SERVER ------------------
// Wir nehmen an, dass du am Server ein ollama_chat_api.py hast, das JSON zurückgibt.
// (Anpassen, wenn dein Pfad anders ist)
let sessionId = "";

// ------------------ TOGGLE-FUNKTION ------------------
function toggleListening() {
  if (isTTSRunning) {
    console.log("Mikrofonsteuerung deaktiviert, da Sprachausgabe läuft.");
    return;
  }

  if (!isListening) {
    // Start
    isListening = true;
    document.getElementById("toggleBtn").textContent = "Mikrofon ausschalten";
    startContinuousRecognition();
  } else {
    // Stop
    isListening = false;
    document.getElementById("toggleBtn").textContent = "Mikrofon einschalten";
    stopContinuousRecognition();
    userInput.disabled = false;
  }
}

// ------------------ START/STOP ERKENNUNG ------------------
function startContinuousRecognition() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "de-DE";
  recognition.interimResults = false;
  recognition.continuous = true;

  recognition.onstart = function() {
    console.log("Spracherkennung gestartet");
    finalTranscript = "";
    lastSpeechTime = Date.now();
    // Jede Sekunde checken, ob >=3s Pause
    checkTimer = setInterval(checkSilence, 200);
  };

  recognition.onresult = function(event) {
    console.log("Es wurde eine Spracheingabe verstanden");
   //  let interimTranscript = "";
     for (let i = event.resultIndex; i < event.results.length; i++) {

        if (!isTTSRunning) {
            let result = event.results[i];
            if(result.isFinal)
            {
              console.log(" TTS läuft nicht. " + finalTranscript);

            //     let chunk = result[0].transcript.toLowerCase().trim();
              finalTranscript += result[0].transcript + " ";

              userInput.value = finalTranscript.trim();
              userInput.disabled = true;
            }
            lastSpeechTime = Date.now();
        }
     }
  };

  recognition.onend = function() {
    console.log("Spracherkennung endete – neu starten, falls toggle noch an");
    clearInterval(checkTimer);
    // Chrome beendet manchmal trotz continuous = true
    // => Also neu starten, wenn isListening
    if (isListening) {
      recognition.start();
    }
  };
  recognition.start();
}

function stopContinuousRecognition() {
  if (recognition) {
    recognition.onend = null;  // nicht wieder neu starten
    recognition.stop();
    recognition = null;
    clearInterval(checkTimer);
  }
}

// ------------------ AUTO-SEND NACH 3S PAUSE ------------------
function checkSilence() {
  let diff = Date.now() - lastSpeechTime;
  // Nach 3s ohne neue Erkennung => abschicken, wenn finalTranscript nicht leer ist
  if (diff >= 200 && finalTranscript.trim() !== "") {
    let text = finalTranscript.trim();
    finalTranscript = "";
    sendMessageToServer(text);
    // Eingabefeld leeren + freigeben
    userInput.value = "";
    userInput.disabled = false;
  }
}

// ------------------ MANUELLES SENDEN ------------------
function sendManual() {
  // Nur senden, wenn Feld nicht leer
  let text = userInput.value.trim();
  if (text === "") return;

  sendMessageToServer(text);

  // Feld leeren + freigeben
  userInput.value = "";
  userInput.disabled = false;
}

function getAPIEndpoint() {
  return "/cgi-bin/distributor.py";  // Ollama Chat API

}

// ------------------ SERVER-AUFUFR (AJAX) ------------------
function sendMessageToServer(text) {
  console.log("Sende an Server:", text);

  chatArray.push({ role: "user", content: text});
  renderChat(true);

  let apiUrl = getAPIEndpoint();  // Wählt den richtigen API-Endpunkt
  let aiModel = document.getElementById("aiModel").value;
  let ttsMode = document.getElementById("ttsMode").value;
  let processingUnit = document.getElementById("processingUnit").value;

  let formData = new FormData();
  formData.append("session_id", sessionId);
  formData.append("user_input", text);
  formData.append("aiModel", aiModel);
  formData.append("ttsMode", ttsMode);
  formData.append("requestType", "aiModel");
  formData.append("processingUnit", processingUnit);

  if (firstRequest) {
    let systemPrompt = document.getElementById("systemPrompt").value;
    formData.append("systemPrompt", systemPrompt);
  }
  firstRequest = false;

  fetch(apiUrl, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    sessionId = data.session_id;
    chatArray = data.chat;
    renderChat(false);
    // Letzten Assistant-Post vorlesen, falls vorhanden
    let lastMsg = data.chat[data.chat.length - 1];
    if (lastMsg && lastMsg.role === "assistant") {
      speakResponse(lastMsg.content);
    }
  })
  .catch(err => console.error("Fehler beim Fetch:", err));

}

// ------------------ CHAT DARSTELLEN ------------------
function renderChat(waiting) {
  const chatbox = document.getElementById("chatbox");
  chatbox.innerHTML = "";
  chatArray.forEach(msg => {
    let p = document.createElement("p");
    let formattedContent = formatTextWithBold(msg.content)
      .replace(/\n/g, '<br>')  // Zeilenumbrüche erhalten
      .replace(/<think>/g, '<think>') // Think-Tags erhalten
      .replace(/<\/think>/g, '</think>');

    if (msg.role === "user") {
      p.innerHTML = `<span class='user'>Du:</span> ${formattedContent}`;
    } else {
      p.innerHTML = `<span class='assistant'>Assistent:</span> ${formattedContent}`;
    }
    chatbox.appendChild(p);
  });
  if(waiting){
    let waitElement = document.createElement("p");
    waitElement.innerHTML = `<span class='waiting'></span> `;
    chatbox.appendChild(waitElement);
  }
  chatbox.scrollTop = chatbox.scrollHeight;
}

function formatTextWithBold(text) {
    // Ersetze **Wort** durch <strong>Wort</strong>
    return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

// ------------------ TTS FÜR OLLAMA-ANTWORT ------------------
let currentUtterance = null; // global

function speakResponse(text) {
    // Den TTS-Modus aus dem <select> abfragen
  let mode = document.getElementById("ttsMode").value;

  if (mode === "browser") {
      // Falls noch eine alte Sprachausgabe läuft, abbrechen
      if (currentUtterance) {
        speechSynthesis.cancel();
      }

      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.lang = "de-DE";

      currentUtterance.onstart = function() {
        isTTSRunning = true;
        console.log("TTS hat begonnen.");
        isListening = false;
        document.getElementById("toggleBtn").disabled = true;
        document.getElementById("toggleBtn").textContent = "Sprachausgabe läuft gerade";
        stopContinuousRecognition();
        userInput.disabled = false;
      };
      currentUtterance.onend = function() {
        isTTSRunning = false;
        currentUtterance = null;
        console.log("TTS ist fertig.");
        isListening = true;
        document.getElementById("toggleBtn").disabled = false;
        document.getElementById("toggleBtn").textContent = "Mikrofon ausschalten";
        startContinuousRecognition();
      };

      window.speechSynthesis.speak(currentUtterance);
    } else {
        // 2) Coqui TTS -> wir holen vom Server ein WAV und spielen es ab
      fetchCoquiTTSAndPlay(text);
  }
}

function cancelTTS() {
  if (currentUtterance) {
    speechSynthesis.cancel(); // Abbrechen
    currentUtterance = null;
  }
  finalTranscript = "";
  isTTSRunning = false;
  console.log("TTS manuell abgebrochen!");
}

function fetchCoquiTTSAndPlay(text) {
    // Sende Text an distributor.py der es an TTS-Server weiterleitet
    let formData = new FormData();
    formData.append("text", text);
    formData.append("requestType", "ttsMode");

    fetch("/cgi-bin/distributor.py", {
        method: "POST",
        body: formData
    })
    .then(response => response.blob())
    .then(blob => {
        // Audio wie zuvor abspielen
        let audioUrl = URL.createObjectURL(blob);
        let audio = new Audio(audioUrl);
        audio.onplay = () => {
            isTTSRunning = true;
            stopContinuousRecognition();
            document.getElementById("toggleBtn").disabled = true;
            document.getElementById("toggleBtn").textContent = "Sprachausgabe läuft gerade";
        };
        audio.onended = () => {
            isTTSRunning = false;
            startContinuousRecognition();
            document.getElementById("toggleBtn").disabled = false;
            document.getElementById("toggleBtn").textContent = "Mikrofon ausschalten";
        };
        audio.play();
    })
    .catch(err => console.error("Fehler bei TTS:", err));
}

</script>
</body>
</html>
